

# Vendor Application Unauthorized – Architecture Handoff Summary

## Executive Summary
- The vendor application Edge Function [submit-vendor-application](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application:0:0-0:0) consistently returns an authorization error even when the frontend shows an authenticated user and a valid-looking JWT is sent.
- Live function config shows `verify_jwt=false` (intended so the function handles auth manually), yet responses are `400` with no diagnostic metadata, suggesting a deployment/version drift or code path mismatch.
- The working [cart-manager](cci:7://file:///d:/kb-stylish/supabase/functions/cart-manager:0:0-0:0) function uses a resilient pattern (header parity, guest fallback) that our vendor submission does not currently mirror.

---

## Current Symptom
- Frontend shows the user is logged in and `getUser()` returns a user and `getSession()` returns a session.
- The POST to `https://poxjcaogjupsplrcliau.supabase.co/functions/v1/submit-vendor-application` returns:
  - Status: 400
  - Body: `{"success":false,"error":"Unauthorized: You must be logged in","error_code":"AUTH_REQUIRED"}`
- Network confirms `Authorization: Bearer <JWT>` is present. The token issuer and audience appear correct for this project.

---

## Evidence

- **[Frontend logs]** [d:\kb-stylish\src\components\vendor\onboarding\ApplicationForm.tsx](cci:7://file:///d:/kb-stylish/src/components/vendor/onboarding/ApplicationForm.tsx:0:0-0:0)
  - Logs authenticated user via `supabase.auth.getUser()` and `getSession()`.
  - Sends POST with `Authorization: Bearer ${session.access_token}`.

- **[Network capture]**
  - Request includes `Authorization` Bearer JWT.
  - Response headers show proper CORS and project-ref. Status is 400. No diagnostic fields in body.

- **[Function config]** [d:\kb-stylish\supabase\config.toml](cci:7://file:///d:/kb-stylish/supabase/config.toml:0:0-0:0)
  - `[functions.submit-vendor-application] verify_jwt = false` (confirmed in dashboard too).

- **[Edge function version]**
  - Active function reported as version 7 with `verify_jwt=false`.
  - Edge logs show repeated `POST | 400` for [submit-vendor-application](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application:0:0-0:0) (version 7).

- **[Deployed code (expected)]**
  - An inline-auth diagnostic build was deployed earlier (intended to return `401` with a `diag` object on auth failure). Network shows `400` with no `diag`, indicating the live code likely isn’t the diagnostic build.

- **[Working reference]** [d:\kb-stylish\supabase\functions\cart-manager\index.ts](cci:7://file:///d:/kb-stylish/supabase/functions/cart-manager/index.ts:0:0-0:0)
  - Manual auth pattern.
  - Accepts guest via anon key.
  - Client sends `'apikey'` and `credentials: 'include'` and always an `x-guest-token`. Function is resilient even if JWT verification fails.

---

## What We Tried (and Results)

- **[Toggle verify_jwt]**
  - Initially found `verify_jwt=true` was blocking (platform-level). Set to `false` for [submit-vendor-application](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application:0:0-0:0).
  - Verified `verify_jwt=false` is active; error persists.

- **[Redeploys]**
  - Deployed a clean inline-auth version with CORS and auth in the same file to avoid shared import path issues.
  - Deployed a later diagnostic version (v7) intended to return `401` with a `diag` object. Live responses still show `400` and no `diag`. Likely region/rollout or redeploy drift.

- **[Frontend validation]**
  - Confirmed the frontend gets a session and sends `Authorization: Bearer <JWT>`.
  - Confirmed CORS header allow-list includes `http://localhost:3000`.

- **[Cross-function comparison]**
  - Verified [cart-manager](cci:7://file:///d:/kb-stylish/supabase/functions/cart-manager:0:0-0:0) works under real conditions.

---

## Hypotheses

- **[H1: Deployment/Version drift]**
  - The function responding is not the latest diagnostic build. Evidence: body shape and status code mismatch (expect `401 + diag`, got `400` without `diag`).

- **[H2: JWT verification failing inside the function]**
  - `userClient.auth.getUser(token)` likely fails, returning null user. Common causes:
    - Token expired or invalid due to role-version drift (earlier related logs showed role/version mismatches).
    - Subtle environment mismatch between token issuer and the function’s auth client.
  - Without `diag`, we lack the exact `getUserError`.

- **[H3: Header parity differences]**
  - Cart requests include `'apikey'` and `credentials: 'include'` and a guest token. The vendor form currently sends only `Content-Type` and `Authorization`.
  - While not strictly required, parity differences might cause subtle preflight or header handling differences.

- **[H4: Shared module vs inline code confusion]**
  - Local workspace shows a [_shared/auth.ts](cci:7://file:///d:/kb-stylish/supabase/functions/_shared/auth.ts:0:0-0:0)-based version in [d:\kb-stylish\supabase\functions\submit-vendor-application\index.ts](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application/index.ts:0:0-0:0).
  - If CLI deploys used that file (not the inline build), it could explain the 400/no-diag behavior, even with `verify_jwt=false`.

---

## Gaps / Open Questions

- **[Which code is truly live?]** Live behavior (status 400 + no diag) doesn’t match the diagnostic inline build we expect.
- **[Exact auth error]** We need `getUserError` from the function to confirm whether it’s expiry, invalid signature, audience, or role-version mismatch.
- **[Do we need `'apikey'` on client calls here?]** In theory `supabase-js` client inside the function uses the anon key internally, but client-side parity may help.

---

## Proposed Next Steps (Minimal Risk)

- **[1. Force diagnostic build live]**
  - Update the function to always return `401` with `diag` on auth failure and include a `diag_version: "v8"` marker.
  - Redeploy via CLI using [supabase/config.toml](cci:7://file:///d:/kb-stylish/supabase/config.toml:0:0-0:0) (to ensure `verify_jwt=false` persists).
  - After propagation, capture and share the full response JSON (including `diag`).

- **[2. Frontend parity with cart]**
  - In [ApplicationForm.tsx](cci:7://file:///d:/kb-stylish/src/components/vendor/onboarding/ApplicationForm.tsx:0:0-0:0) [submitWithRetry(...)](cci:1://file:///d:/kb-stylish/src/components/vendor/onboarding/ApplicationForm.tsx:118:2-170:4):
    - Add header `'apikey': process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY`.
    - Add `credentials: 'include'`.
    - Log a safe token fingerprint (length and first 12 chars) to rule out empty/malformed tokens at call time.
  - This mirrors what works in [cart-manager](cci:7://file:///d:/kb-stylish/supabase/functions/cart-manager:0:0-0:0).

- **[3. Edge auth hardening (if needed)]**
  - In the function, if `auth.getUser(token)` fails, attempt `userClient.auth.getUser()` using the global Authorization header to avoid param parsing edge-cases.
  - Always include `getUserError` in `diag`.

- **[4. If token is bad]**
  - If `diag.getUserError` shows expiry/invalid signature, enforce sign-out/in to refresh the token and re-test.

---

## Longer-Term Hardening

- **[Single-source Edge deployment]**
  - Avoid mixing CLI and another deploy path that might publish different builds. Ensure only the intended build pipeline is used.

- **[Unify shared vs inline modules]**
  - If imports caused path/version drift earlier, either fully inline or lock [_shared/](cci:7://file:///d:/kb-stylish/supabase/functions/_shared:0:0-0:0) paths and include unit tests.

- **[Test scripts]**
  - Maintain a small PowerShell/curl script to hit the function with a known JWT and return `diag` for quick verification across regions.

---

## Files/Paths Referenced

- **Frontend submit**: [src/components/vendor/onboarding/ApplicationForm.tsx](cci:7://file:///d:/kb-stylish/src/components/vendor/onboarding/ApplicationForm.tsx:0:0-0:0)
- **Working reference**: [supabase/functions/cart-manager/index.ts](cci:7://file:///d:/kb-stylish/supabase/functions/cart-manager/index.ts:0:0-0:0)
- **Vendor function (workspace)**: [supabase/functions/submit-vendor-application/index.ts](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application/index.ts:0:0-0:0)
- **Shared auth utils**: [supabase/functions/_shared/auth.ts](cci:7://file:///d:/kb-stylish/supabase/functions/_shared/auth.ts:0:0-0:0)
- **Config**: [supabase/config.toml](cci:7://file:///d:/kb-stylish/supabase/config.toml:0:0-0:0)
- **Diagnostic scripts**: [scripts/test_diag.ps1](cci:7://file:///d:/kb-stylish/scripts/test_diag.ps1:0:0-0:0), [scripts/test_edge_directly.ps1](cci:7://file:///d:/kb-stylish/scripts/test_edge_directly.ps1:0:0-0:0)

---

## Status

- **verify_jwt=false** for [submit-vendor-application](cci:7://file:///d:/kb-stylish/supabase/functions/submit-vendor-application:0:0-0:0): applied.
- **Diagnostic build live**: suspected NOT serving; responses show `400` with no `diag`.
- **Header parity changes**: not applied yet; pending approval.
- **Awaiting `diag`**: needed to identify precise `getUser` failure and finalize the fix.